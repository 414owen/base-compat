diff --git a/.travis.yml b/.travis.yml
index 6bc054d..4857151 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -6,6 +6,13 @@
 #
 # version: 0.2.1
 #
+# The file is patched:
+# - We install typediff utility from the repoistory
+# - Generation of cabal.project file is amended: When BATTERIES=NO is set,
+#   we exclude `base-compat-batteries` and `check` package/directories.
+#   Note: TEST=--disable-tests is assumed to be set too.
+# - These changes are in travis.yml.patch
+#
 language: c
 dist: xenial
 
@@ -100,6 +107,10 @@ before_install:
   - unset CC
   - CABAL=/opt/ghc/bin/cabal
   - CABALHOME=$HOME/.cabal
+  # install typediff
+  - mkdir -p $HOME/.local/bin
+  - curl -L https://github.com/haskell-compat/base-compat/releases/download/typediff-0.1.3/typediff > $HOME/.local/bin/typediff
+  - chmod +x $HOME/.local/bin/typediff
   - export PATH="$CABALHOME/bin:$PATH"
   - ROOTDIR=$(pwd)
   - HCNUMVER=$(( $(${HC} --numeric-version|sed -E 's/([0-9]+)\.([0-9]+)\.([0-9]+).*/\1 * 10000 + \2 * 100 + \3/') ))
@@ -117,9 +128,14 @@ install:
   - grep -Ev -- '^\s*--' $CABALHOME/config | grep -Ev '^\s*$'
   - rm -f cabal.project
   - touch cabal.project
-  - "printf 'packages: \"./base-compat\"\\n' >> cabal.project"
-  - "printf 'packages: \"./base-compat-batteries\"\\n' >> cabal.project"
-  - "printf 'packages: \"./check\"\\n' >> cabal.project"
+  - >
+    if [ "x$BATTERIES" = "xNO" ]; then
+      "printf 'packages: \"./base-compat\"\\n' >> cabal.project";
+    else
+      "printf 'packages: \"./base-compat\"\\n' >> cabal.project";
+      "printf 'packages: \"./base-compat-batteries\"\\n' >> cabal.project";
+      "printf 'packages: \"./check\"\\n' >> cabal.project";
+    fi
   - "printf 'write-ghc-environment-files: always\\n' >> cabal.project"
   - touch cabal.project.local
   - "for pkg in $($HCPKG list --simple-output); do echo $pkg | sed 's/-[^-]*$//' | grep -vE -- '^(base-compat|base-compat-batteries|type-check)$' | sed 's/^/constraints: /' | sed 's/$/ installed/' >> cabal.project.local; done"
@@ -132,8 +148,8 @@ install:
   - ${CABAL} new-freeze -w ${HC} ${TEST} ${BENCH} --project-file="cabal.project" --dry
   - "cat \"cabal.project.freeze\" | sed -E 's/^(constraints: *| *)//' | sed 's/any.//'"
   - rm  "cabal.project.freeze"
-  - ${CABAL} new-build -w ${HC} ${TEST} ${BENCH} --project-file="cabal.project" --dep -j2 all
-  - ${CABAL} new-build -w ${HC} --disable-tests --disable-benchmarks --project-file="cabal.project" --dep -j2 all
+  - travis_wait ${CABAL} new-build -w ${HC} ${TEST} ${BENCH} --project-file="cabal.project" --dep -j2 all
+  - travis_wait ${CABAL} new-build -w ${HC} --disable-tests --disable-benchmarks --project-file="cabal.project" --dep -j2 all
   - rm -rf .ghc.environment.* "./base-compat"/dist "./base-compat-batteries"/dist "./check"/dist
   - DISTDIR=$(mktemp -d /tmp/dist-test.XXXX)
 
@@ -147,9 +163,14 @@ script:
   - find . -maxdepth 1 -name '*.tar.gz' -exec tar -xvf '{}' \;
   - rm -f cabal.project
   - touch cabal.project
-  - "printf 'packages: \"base-compat-*/*.cabal\"\\n' >> cabal.project"
-  - "printf 'packages: \"base-compat-batteries-*/*.cabal\"\\n' >> cabal.project"
-  - "printf 'packages: \"type-check-*/*.cabal\"\\n' >> cabal.project"
+  - >
+    if [ "x$BATTERIES" = "xNO" ]; then
+      "printf 'packages: \"./base-compat\"\\n' >> cabal.project";
+    else
+      "printf 'packages: \"./base-compat\"\\n' >> cabal.project";
+      "printf 'packages: \"./base-compat-batteries\"\\n' >> cabal.project";
+      "printf 'packages: \"./check\"\\n' >> cabal.project";
+    fi
   - "printf 'write-ghc-environment-files: always\\n' >> cabal.project"
   - touch cabal.project.local
   - "for pkg in $($HCPKG list --simple-output); do echo $pkg | sed 's/-[^-]*$//' | grep -vE -- '^(base-compat|base-compat-batteries|type-check)$' | sed 's/^/constraints: /' | sed 's/$/ installed/' >> cabal.project.local; done"
@@ -164,8 +185,8 @@ script:
 
   # cabal check
   - (cd base-compat-* && ${CABAL} check)
-  - (cd base-compat-batteries-* && ${CABAL} check)
-  - (cd type-check-* && ${CABAL} check)
+  - if [ ! "x$BATTERIES" = "xNO" ]; then (cd base-compat-batteries-* && ${CABAL} check); fi
+  - if [ ! "x$BATTERIES" = "xNO" ]; then (cd type-check-* && ${CABAL} check); fi
 
   # haddock
   - ${CABAL} new-haddock -w ${HC} ${TEST} ${BENCH} all
